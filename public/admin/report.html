<!DOCTYPE html>
<html lang="vi">
<head>
  <meta charset="UTF-8" />
  <title>Báo cáo theo lớp</title>
  <style>
    body { font-family: system-ui, sans-serif; max-width: 720px; margin: 32px auto; }
    .box { border: 1px solid #ddd; padding: 16px; border-radius: 8px; margin-top: 12px; }
    label { display: block; margin: 8px 0; }
    input { padding: 8px; width: 100%; }
    button { padding: 8px 14px; cursor: pointer; }
    .ok { color: #0a7f3e }
    .err { color: #b00020 }
    iframe { width: 100%; height: 360px; border: 1px solid #eee; border-radius: 6px; }
  </style>
</head>
<body>
  <h1>Báo cáo kết quả theo lớp</h1>

  <div class="box">
    <label>Lớp: <input id="classId" placeholder="VD: 10A1" /></label>
    <label>Khung giờ: <input id="schedule" placeholder="VD: 8:00–9:00" /></label>
    <label>Email nhận: <input id="to" placeholder="Mặc định dùng EMAIL_TO" /></label>
    <label><input type="checkbox" id="attach" checked /> Đính kèm Excel</label>
    <label><input type="checkbox" id="answers" /> Bao gồm đáp án</label>

    <button id="previewBtn">Xem trước</button>
    <button id="sendBtn">Gửi báo cáo</button>
    <div id="status"></div>
  </div>

  <div class="box" id="previewBox" style="display:none">
    <h3>Xem trước</h3>
    <iframe id="previewFrame"></iframe>
  </div>

<script>
const classIdEl = document.getElementById('classId');
const scheduleEl = document.getElementById('schedule');
const toEl = document.getElementById('to');
const statusEl = document.getElementById('status');
const previewBox = document.getElementById('previewBox');
const previewFrame = document.getElementById('previewFrame');

document.getElementById('previewBtn').addEventListener('click', () => {
  const classId = classIdEl.value.trim();
  const schedule = encodeURIComponent(scheduleEl.value.trim());
  if (!classId) return statusEl.innerHTML = '<p class="err">Vui lòng nhập lớp</p>';
  previewBox.style.display = 'block';
  previewFrame.src = `/exam/report/${classId}/preview?schedule=${schedule}`;
});

document.getElementById('sendBtn').addEventListener('click', async () => {
  statusEl.innerHTML = '';
  const classId = classIdEl.value.trim();
  const schedule = scheduleEl.value.trim();
  const to = toEl.value.trim();

  if (!classId) return statusEl.innerHTML = '<p class="err">Vui lòng nhập lớp</p>';

  try {
    const res = await fetch(`/exam/report/${classId}`, {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({ schedule, to: to || undefined }),
    });
    const data = await res.json();
    if (!res.ok) throw new Error(data?.error || 'Gửi thất bại');

    statusEl.innerHTML = `<p class="ok">Đã gửi báo cáo lớp ${data.classId} cho ${data.to}. Số bản ghi: ${data.count}</p>`;
  } catch (err) {
    statusEl.innerHTML = `<p class="err">${err.message}</p>`;
  }
});
</script>
</body>
</html>
